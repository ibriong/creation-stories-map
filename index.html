<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Creation Stories Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; display: flex; }
    #map { flex: 1; height: 100vh; }
    #sidebar {
      width: 300px;
      max-width: 100%;
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      overflow-y: auto;
      display: none;
      flex-direction: column;
    }
    .popup-content { font-size: 14px; line-height: 1.4; }
    .popup-title { font-weight: bold; font-size: 16px; }
    .popup-culture { font-style: italic; margin-bottom: 5px; }
    #sidebar-close {
      align-self: flex-end;
      margin-bottom: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <div id="sidebar-close">&times;</div>
    <div id="sidebar-content"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const myMap = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(myMap);

    const sidebar = document.getElementById('sidebar');
    const sidebarContent = document.getElementById('sidebar-content');
    const sidebarClose = document.getElementById('sidebar-close');

    sidebarClose.addEventListener('click', () => {
      sidebar.style.display = 'none';
    });

    function csvToJson(csv) {
      const lines = csv.split('\\n');
      const headers = lines[0].split(',');
      return lines.slice(1).filter(line => line.trim()).map(line => {
        const data = line.split(',');
        return headers.reduce((obj, header, i) => {
          obj[header.trim()] = data[i] ? data[i].trim() : '';
          return obj;
        }, {});
      });
    }

    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vR8_tIK1VkicYuwADRDSKgZ80kqhMuG6R853PvnU1DaoalV5SwUMh0U4mZX4J95t44R8OpOBcHZG8YF/pub?output=csv')
      .then(response => response.text())
      .then(csv => {
        const stories = csvToJson(csv);
        stories.forEach(story => {
          const lat = parseFloat(story.Latitude);
          const lng = parseFloat(story.Longitude);
          if (isNaN(lat) || isNaN(lng)) return;

          const popupContent = `
            <div class="popup-content">
              <div class="popup-title">${story.Title}</div>
              <div class="popup-culture">${story.Culture}</div>
              <div>${story.Summary}</div>
              <a href="#" class="read-more"
                 data-title="${story.Title}"
                 data-culture="${story.Culture}"
                 data-summary="${story.Summary}"
                 data-source="${story.Source}"
                 data-image="${story.ImageURL}">
                 Read more
              </a>
            </div>`;

          L.marker([lat, lng])
            .addTo(myMap)
            .bindPopup(popupContent);
        });
      });

    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('read-more')) {
        event.preventDefault();
        const title = event.target.getAttribute('data-title');
        const culture = event.target.getAttribute('data-culture');
        const summary = event.target.getAttribute('data-summary');
        const source = event.target.getAttribute('data-source');
        const image = event.target.getAttribute('data-image');

        sidebarContent.innerHTML = `
          <h2>${title}</h2>
          <h4 style="font-style: italic;">${culture}</h4>
          <p>${summary}</p>
          ${image ? `<img src="${image}" alt="${title}" style="max-width:100%;margin:10px 0;">` : ''}
          <p><a href="${source}" target="_blank">Read more at source</a></p>
        `;
        sidebar.style.display = 'flex';
      }
    });
  </script>
</body>
</html>
